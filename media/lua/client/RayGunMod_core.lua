

--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]


require "lua_timers"
RayGunMod = RayGunMod or {}
RayGunMod.dbg = false

function RayGunMod.debug()
    local sq = getPlayer():getSquare()
    sq:AddWorldInventoryItem("Base.ColdCellBattery", 0.5, 0.5, 0);
    sq:AddWorldInventoryItem("Base.ColdCellBattery", 0.5, 0.5, 0);
    sq:AddWorldInventoryItem("Base.RayGun", 0.5, 0.5, 0);
    ISInventoryPage.dirtyUI()
    getDebugOptions():setBoolean("Cheat.Player.UnlimitedAmmo", false)
end

function RayGunMod.doRoll(percent)
    local kd = SandboxVars.RayGunMod.KnockDownPercent or 15
    percent = percent or kd
    if percent == 100 then return true end
    if percent == 0 then return false end
	return percent >= ZombRand(1, 101)
end




function RayGunMod.isValid(pl)
    pl = pl or getPlayer()
	if tostring(WeaponType.getWeaponType(pl)) == "barehand" then return false end
    local wpn = pl:getPrimaryHandItem()
	if not wpn then return false end
	if wpn:isAimedFirearm() and wpn:getScriptItem():isRanged() and not pl:isDoShove() then
        local modData = wpn:getModData()
        return modData and modData.isRayGun
    end
    return false
end

function RayGunMod.stag(targ)
    targ = targ or getPlayer()

    local DeathChance = SandboxVars.RayGunMod.DeathChance or 2

    if RayGunMod.doRoll() then
        targ:setBumpType("stagger");
        targ:setVariable("BumpDone", true);
        targ:setVariable("BumpFall", true);
        targ:setVariable("BumpFallType", "pushedFront");
        targ:reportEvent("wasBumped")
        local body = targ:getBodyDamage()
        local hp = body:getOverallBodyHealth()
        local dmg = SandboxVars.RayGunMod.ZedDmg or 15
        body:ReduceGeneralHealth(hp-dmg)
        --targ:dropHandItems()
    elseif RayGunMod.doRoll(DeathChance) then
        targ:Kill(targ)
    end
end
function RayGunMod.AoE(sq, isFromSource)
    local rad = SandboxVars.RayGunMod.ExplosionRadius or 2
    local cell = getCell()
    local x, y, z = sq:getX(), sq:getY(), sq:getZ()

    for xDelta = -rad, rad do
        for yDelta = -rad, rad do
            local sq = cell:getOrCreateGridSquare(x + xDelta, y + yDelta, z)
            for i=1, sq:getMovingObjects():size() do
                local targ = sq:getMovingObjects():get(i-1)
                if isFromSource then
                    if instanceof(targ, "IsoZombie") then
                        RayGunMod.doZedDmg(targ)
                    end
                end
                if instanceof(targ, "IsoPlayer") then
                    RayGunMod.stag(targ)
                end
            end
        end
    end
end



function RayGunMod.doZedDmg(zed)
    local kd = SandboxVars.RayGunMod.ZedKnockDownPercent or 15
    if RayGunMod.doRoll(kd) then
        zed:setKnockedDown(true)
		zed:setCrawler(true);
		zed:setCanCrawlUnderVehicle(true)
		zed:setFallOnFront(true);
		zed:setCanWalk(false);
    end
    local ZedDmg = SandboxVars.RayGunMod.ZedDmg or 15
    if ZedDmg > 0 then
        local dmg = math.max(0, math.min(1, ZedDmg/100 ))
        local hp = zed:getHealth() - dmg
        if hp then
            zed:setHealth(hp)
        end
    end
    zed:update()
end
--[[
function RayGunMod.checkDist(pl, targ)
    local x, y = targ:getX(), targ:getY()
    local px, py = pl:getX(), pl:getY()
    return math.floor(math.sqrt((px - x) ^ 2 + (py - y) ^ 2))
end

 ]]