--[[██████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                        				 Custom  PZ  Mod  Developer  for  Hire													  |
|‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾‾|
|                       	Portfolio:  https://steamcommunity.com/id/glytch3r/myworkshopfiles/							          |
|                       		                                    														 	  |
|                       	Discord:    Glytch3r#1337 / glytch3r															      |
|                       		                                    														 	  |
|                       	Support:    https://ko-fi.com/glytch3r														    	  |
|_______________________________________________________________________________________________________________________________-]]
--[[_____________________________________________________________________________________________________________________________
   ░▒▓██████▓▒░    ░▒▓████████▓▒░    ░▒▓█▓▒░         ░▒▓█▓▒░      ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░           ░▒▓█▓▒░         ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▓▒░  ░▒▓▒░
  ░▒▓█▓▒▒▓███▓▒░   ░▒▓█▓▒░         ░▒▓██████▓▒░      ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█████████▓▒░     ░▒▓███▓▒░     ░▒▓███████▓▒░
  ░▒▓█▓▒░          ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░         ░▒▓█▓▒░ ░▒▓█▓▒░         ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
  ░▒▓█▓▒░░▒▓█▓▒░   ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░     ░▒▓█▓▒░     ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓█▓▒░ ░▒▓█▓▒░  ▒▓░    ░▒▓█▓▒░   ░▒▓█▒░  ░▒▓█▒░
   ░▒▓█████▓▒░     ░▒▓█▓▒░        ░▒▓█▓▒░░▒▓█▓▒░  ░▒▓███████▓▒░   ░▒▓██████▓▒░   ░▒▓█▓▒░ ░▒▓█▓▒░  ░▒▓███████▓▒░    ░▒▓███████▓▒░
█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████--]]

RayGunMod = RayGunMod or {}

function RayGunMod.getHighestChargeCell(inv, batteries)
    inv = inv or getPlayer():getInventory()
    if not inv then return nil end

    local bestCell = nil
    local bestCharge = -1

    batteries = batteries or inv:FindAll("Base.ColdCellBattery")
    for i = 0, batteries:size() - 1 do
        local item = batteries:get(i)
        if item then
            local data = item:getModData()
            local charge = tonumber(data.ColdCell) or 10
            if charge > bestCharge then
                bestCharge = charge
                bestCell = item
            end
        end
    end

    return bestCell
end


local hook_loadAmmo = ISReloadWeaponAction.loadAmmo
function ISReloadWeaponAction:loadAmmo()
    if RayGunMod.isRayGun(self.gun) then
        local inv = self.character:getInventory()
        if self.bullets then
            if not self.bullets:isEmpty() and self.gun:getCurrentAmmoCount() < self.gun:getMaxAmmo() then

                --local batt = RayGunMod.getHighestChargeCell(inv, self.bullets) or  self.bullets:get(0);
                local batt = self.bullets:get(0)
                local battData = batt:getModData()
                battData.ColdCell = battData.ColdCell or 10

                local modData = self.gun:getModData()
                modData.ColdCell =  modData.ColdCell or 0
                modData.ColdCell = math.min(20, modData.ColdCell + battData.ColdCell)

                self.bullets:remove(batt);
                inv:Remove(batt);


            end

            if self.bullets:isEmpty() or self.gun:getCurrentAmmoCount() >= self.gun:getMaxAmmo() then
                self.character:clearVariable("isLoading");
                if self.gun:haveChamber() and not self.gun:isRoundChambered() then
                    ISTimedActionQueue.addAfter(self, ISRackFirearm:new(self.character, self.gun));
                end
                self:forceComplete();
--[[             elseif self.gun:isInsertAllBulletsReload() then
                self:loadAmmo() ]]
            end

        end
        return               RayGunMod.refresh(self.gun)
	end
	return hook_loadAmmo(self)
end

local hook_removeBullet = ISRackFirearm.removeBullet
function ISRackFirearm:removeBullet()
    if self.gun and RayGunMod.isRayGun(self.gun) then
        RayGunMod.removeBullet(self.character, self.gun)
    end
    return hook_removeBullet(self)
end



function RayGunMod.removeBullet(pl, wpn)
    if wpn and RayGunMod.isRayGun(wpn) then
        local inv = pl:getInventory()
        local modData = wpn:getModData()
        modData.ColdCell = modData.ColdCell or 0
        local charge = modData.ColdCell
        local toRemove = 10
        if charge > 10 then
            toRemove = charge - 10
        else
            toRemove = charge
        end
        modData.ColdCell =  math.max(0, charge - toRemove)
        local batt = InventoryItemFactory.CreateItem("Base.ColdCellBattery")
        batt:getModData().ColdCell = math.min(10, toRemove)
        if toRemove > 0 then
            inv:AddItem(batt)
        end
        return RayGunMod.refresh(wpn)
    end
end

function RayGunMod.context(player, context, worldobjects, test)
	context:removeOptionByName("Unload Ray Gun")
	context:removeOptionByName("Unload 1 Round From Ray Gun")
	context:removeOptionByName("Insert 2 Cold Cell Battery in Ray Gun")
	context:removeOptionByName("Insert 3 Cold Cell Battery in Ray Gun")
end
Events.OnFillInventoryObjectContextMenu.Add(RayGunMod.context)




--[[
local hook_BeginAutomaticReload = ISReloadWeaponAction.BeginAutomaticReload
function ISReloadWeaponAction.BeginAutomaticReload(pl, wpn)
    if not wpn or not RayGunMod.isRayGun(wpn) then return hook_BeginAutomaticReload(pl, wpn) end
    return ISReloadWeaponAction:loadAmmo()
end
 ]]
--[[
function ISReloadWeaponAction:loadAmmo()
    if RayGunMod.isRayGun(self.gun) then
        local inv = self.character:getInventory()
        local modData = self.gun:getModData()
        modData.ColdCell = modData.ColdCell or 0
        local maxCharge = 20
        local needed = maxCharge - modData.ColdCell
        if needed <= 0 then
            self.character:clearVariable("isLoading")
            self:forceComplete()
            return
        end

        local items = inv:getItems()
        for i = items:size() - 1, 0, -1 do
            local item = items:get(i)
            if item:getFullType() == "Base.ColdCellBattery" then
                local battData = item:getModData()
                battData.ColdCell = battData.ColdCell or 10
                local charge = battData.ColdCell

                if charge > 0 then
                    local transfer = math.min(charge, needed)
                    modData.ColdCell = modData.ColdCell + transfer
                    needed = needed - transfer
                    charge = charge - transfer

                    if charge > 0 then
                        battData.ColdCell = charge
                    else
                        inv:Remove(item)
                    end

                    if needed <= 0 then break end
                else
                    inv:Remove(item)
                end
            end
        end

        local ammoCount = math.ceil(modData.ColdCell / 10)
        self.gun:setCurrentAmmoCount(ammoCount)

        self.character:clearVariable("isLoading")
        self:forceComplete()

        if self.gun:haveChamber() and not self.gun:isRoundChambered() then
            ISTimedActionQueue.addAfter(self, ISRackFirearm:new(self.character, self.gun))
        end

    else
        hook_loadAmmo(self)
    end
end
 ]]
-----------------------            ---------------------------
--[[
local hook_OnPressRackButton = ISReloadWeaponAction.OnPressRackButton
function ISReloadWeaponAction.OnPressRackButton(pl, wpn)
    if ISReloadWeaponAction.disableReloading then return end
    if not ISReloadWeaponAction.canRack(wpn) then return end

    if RayGunMod.isRayGun(wpn) then
        local modData = wpn:getModData()
        modData.ColdCell = modData.ColdCell or 0

        if modData.ColdCell > 0 then
            local inv = pl:getInventory()
            local cell = InventoryItemFactory.CreateItem("Base.ColdCellBattery")
            if cell then
                cell:getModData().ColdCell = modData.ColdCell
                cell:setTooltip("Charge: " .. modData.ColdCell)
                inv:AddItem(cell)
            end

            modData.ColdCell = 0
            wpn:setCurrentAmmoCount(0)
            RayGunMod.refresh(wpn)

            if wpn:getRackSound() then
                pl:getEmitter():playSound(wpn:getRackSound())
            end

            ISTimedActionQueue.clear(pl)
            return
        else
            return
        end
    end

    hook_OnPressRackButton(pl, wpn)
end
 ]]
-----------------------            ---------------------------


--[[
local hook_start = ISReloadWeaponAction.start
function ISReloadWeaponAction:start()
    if self.weapon and RayGunMod.isRayGun(self.weapon) then
        local inv = self.character:getInventory()
        local coldCell = inv:FindAndReturn("Base.ColdCellBattery")

        if not coldCell then
            self:forceStop()
            return
        end

        if self.weapon:getCurrentAmmoCount() < 0 then
            self.weapon:setCurrentAmmoCount(0)
        end
        if self.weapon:getCharge() < 0 then
            self.weapon:setCharge(0)
        end
    end

    return hook_start(self)
end
 ]]
-----------------------            ---------------------------


--[[
local hook_canRack = ISReloadWeaponAction.canRack
function ISReloadWeaponAction.canRack(wpn)
    if wpn and RayGunMod.isRayGun(wpn) then
        return false
    end
    return hook_canRack(wpn)
end
jkfdfafffafffff
local hook_canShoot = ISReloadWeaponAction.canShoot
function ISReloadWeaponAction.canShoot(wpn)
    if wpn and RayGunMod.isRayGun(wpn) then
        return wpn:getModData().ColdCell and wpn:getModData().ColdCell > 0
    end
    return hook_canShoot(wpn)
end
 ]]
--[[ local hook_onShoot = ISReloadWeaponAction.onShoot
function ISReloadWeaponAction.onShoot(pl, wpn)
    if wpn and RayGunMod.isRayGun(wpn) then
        return
    end
    return hook_onShoot(pl, wpn)
end
 ]]
